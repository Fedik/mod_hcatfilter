(function(b,a,c){c.relatedSelect=function(e,d){this.$element=c(e);this.options=c.extend({},c.relatedSelect.defaults,d);this.tree=this.options.tree;if(this.options.loadingImage){this.$loadingImage=c("<img/>",{src:this.options.loadingImage,alt:"Loading...","class":"loading-animation"})}if(this.options.instantInit){this.updateTree()}};c.relatedSelect.prototype.init=function(){this.updateTree()};c.relatedSelect.prototype.updateTree=function(e){this.$element.trigger("update",[e]);if(e){var d=c(e);d.nextAll("label").remove();d.nextAll("select").remove();var f=d.val();if(this.options.requestUrl&&f!=this.options.emptyValue&&!this.tree[f]){this.requestChildren(e)}else{this.addSelect(f)}}else{this.$element.find("label").remove();this.$element.find("select").remove();this.addSelect()}};c.relatedSelect.prototype.addSelect=function(e){var d=this.options.name,n=this.options.root,p=[];if(!e){p=this.tree[n]}else{if(e&&this.tree[e]&&this.tree[e].length){p=this.tree[e];d+=e}else{return}}var h=c("<select/>",{name:d});this.$element.append(h);h.on("change",function(i){this.updateTree(i.target)}.bind(this));if(this.options.labels.length){var m=h.prevAll("select").length;var k=this.options.labels[m];if(k){var o=c("<label/>",{"for":d,html:k});h.before(o)}}h.append(c("<option/>",{value:this.options.emptyValue,html:this.options.choose}));for(var j=0,g=p.length;j<g;j++){var f=p[j];h.append(c("<option/>",{value:f.value,html:f.title}));if(this.options.preselect.length&&this.options.preselect.indexOf(f.value)!==-1){h.val(f.value);h.trigger("change")}}};c.relatedSelect.prototype.resetTree=function(d){if(d){this.options.preselect=[]}this.updateTree()};c.relatedSelect.prototype.requestChildren=function(e){var f=c(e).val();if(this.$loadingImage){c(e).after(this.$loadingImage)}var d=c.ajax({url:this.options.requestUrl,type:"POST",dataType:"json",data:{"jquery.relatedSelect":1,id:f}});d.done(function(g){if(this.$loadingImage){this.$loadingImage.remove()}if(g.length){this.tree[f]=g}this.addSelect(f)}.bind(this));d.fail(function(g,h){if(this.$loadingImage){this.$loadingImage.remove()}console.log("Request failed: "+h)}.bind(this))};c.relatedSelect.defaults={root:0,tree:[],name:"selectedItem",choose:"Choose...",emptyValue:"",requestUrl:null,loadingImage:"",preselect:[],labels:[],instantInit:true};c.fn.relatedSelect=function(e){var d=c(this).data("relatedSelect");if(!d){d=new c.relatedSelect(this,e);c(this).data("relatedSelect",d)}return d}})(window,document,jQuery);